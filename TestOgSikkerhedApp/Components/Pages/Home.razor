@page "/"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity;
@using TestOgSikkerhedApp.Data;
@using TestOgSikkerhedApp.Repositories;
@inject IServiceProvider _serviceProvider;
@* @inject UserManager<Data.ApplicationUser> UserManager; *@
@inject AuthenticationStateProvider _authenticationStateProvider;
@inject Codes.HashingHandler _hashingHandler;
@inject ToDoItemRepo _todoRepo;
@inject CprRepo _cprRepo;

@attribute [Authorize(Policy = "AuthenticatedUser")]




    <PageTitle>To Do List App</PageTitle>

    <AuthorizeView>
        <h1 class="text-center mt-4 mb-3">Hello @context.User.Identity?.Name!</h1>
    </AuthorizeView>

    @if (isNotAuthCpr)
    {
        <h3 class="text-center mb-5">Please enter your cpr: </h3>

        <div class="d-flex justify-content-center">

        <input class="text-center m-1" type="text" @bind="@inputValueCpr" placeholder="XXXXXX-XXXX" @oninput="OnCprInput">

            <button class="btn-info m-1" @onclick="addCpr">Submit</button>

        </div>

        @if (wrongCpr)
        {
            <p>test wrong cpr number</p>
        }
    }
    else
    {
        <h3 class="text-center mb-5">Enter ToDo item: </h3>

        <div class="d-flex justify-content-center">

        <input class="text-center m-1" type="text" @bind="@inputValueItem" placeholder="Things you need to get done" @oninput="OnItemInput">

        <button class="btn-info m-1" @onclick="addItem">Add Item</button>

        </div>

        <table class="table table-striped table-bordered mt-4">
            <thead>
                <tr>
                    <th>Todo:</th>

                </tr>
            </thead>
            <tbody>
            @foreach (var item in toDos.Where(x => x.userName == _userName))
                {
                    <tr>
                        <td>@item.itemName</td>
                    </tr>
                }
            </tbody>
        </table>
    }



@code {
    // authorized variables
    private bool _isAuthenticated;
    private bool _isAdmin;
    public bool IsAuthenticated => _isAuthenticated;
    public bool IsAdmin => _isAdmin;
    public bool isNotAuthCpr = true;
    public string _userName;
    public bool wrongCpr = false;

    // input related variables
    private string? cprNum = "";
    private string inputValueCpr;
    private string inputValueItem;

    // database variables

    private List<ToDoItem> toDos = new List<ToDoItem>();
    private List<CprUser> cprs = new List<CprUser>();



    protected override async Task OnInitializedAsync()
    {
        var authenticationState = await _authenticationStateProvider.GetAuthenticationStateAsync();
        var authUser = authenticationState.User;
        _isAuthenticated = authUser.Identity.IsAuthenticated;
        _isAdmin = authUser.IsInRole("Admin");
        _userName = authUser.Identity.Name;

        //Hashing Test SHA256 - USE
        string textToHashSha = "Aisha";
        string hashedValueSha = _hashingHandler.SHA256Hashing(textToHashSha);


        toDos = await _todoRepo.GetAllTodo();
        cprs = await _cprRepo.GetAllCpr();

        // not the right way to do this, just example instead of manual creation, make page to add email and role
        // await CreateUserRolesAsync("skjoldann@gmail.com", "Admin");
    }

    private void OnCprInput(ChangeEventArgs e)
    {
        var inputValue = (string)e.Value;
    }

    private void OnItemInput(ChangeEventArgs e)
    {
        inputValueItem = (string)e.Value;
    }

    private async Task addCpr()
    {
        cprNum = inputValueCpr;
        var hashedCprNum = _hashingHandler.SHA256Hashing(cprNum.ToString());

        if(cprs.Count == 0)
        {
            if (!string.IsNullOrEmpty(inputValueItem))
            {
                CprUser newCpr = new CprUser
                    {
                        cprNum = hashedCprNum,
                        userName = _userName

                    };

                await _cprRepo.CreateCprAsync(newCpr);

                inputValueCpr = "";
                isNotAuthCpr = false;

            }
        }

        foreach(var cprNumber in cprs)
        {

            if (cprNumber.cprNum == hashedCprNum)
            {
                if(cprNumber.userName == _userName)
                {
                    inputValueCpr = "";
                    wrongCpr = false;
                    isNotAuthCpr = false;

                } else
                {
                    wrongCpr = true;
                }
            } 
            else
            {
                if (!string.IsNullOrEmpty(inputValueItem))
                {
                    CprUser newCpr = new CprUser
                        {
                            cprNum = hashedCprNum,
                            userName = _userName

                        };

                    await _cprRepo.CreateCprAsync(newCpr);

                    inputValueCpr = "";
                    isNotAuthCpr = false;

                }
            }
        }

        StateHasChanged();
    }

    private async Task addItem()
    {
        if (!string.IsNullOrEmpty(inputValueItem))
        {
            ToDoItem newItem = new ToDoItem
                {
                    itemName = inputValueItem,
                    userName = _userName
                };

            await _todoRepo.CreateTodoAsync(newItem);

            inputValueItem = string.Empty;

            toDos = await _todoRepo.GetAllTodo();
        }
    }

    // public async Task CreateUserRolesAsync(string user, string role)
    // {
    //     var roleManager = _serviceProvider.GetRequiredService<RoleManager<IdentityRole>>();
    //     var userManager = UserManager;

    //     var userRoleCheck = await roleManager.RoleExistsAsync(role);
    //     if (!userRoleCheck)
    //     {
    //         await roleManager.CreateAsync(new IdentityRole(role));
    //     }

    //     Data.ApplicationUser identityUser = await userManager.FindByEmailAsync(user);
    //     await userManager.AddToRoleAsync(identityUser, role);
    // }
}